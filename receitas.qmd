---
title: "Receitas"
editor: visual
lang: "pt"
format:
  html:
    code-fold: true
    code-summary: "mostrar o código"
    code-overflow: wrap
execute:
  warning: false
  message: false
  error: false
  freeze: auto  # re-render only when source changes  
---

[dados abertos](https://portaldatransparencia.gov.br/download-de-dados)

```{r bibliotecas}
#| warning: false
#| message: false
#| error: false
library(readxl)
library(tidyverse)
library(janitor)
library(lubridate)
library(tidyverse)
library(purrr)
library(knitr)
library(kableExtra)
library(DescTools)
library(zoo)
library(stringr)
library(igraph)
library(data.table)
library(DT)
```

```{r funcoes_e_opcoes}

# negar %in%
`%notin%` <- Negate(`%in%`)

# formato dos numeros
myNumFmt <- as.fmt(digits=0, big.mark=".")

options(scipen = 999)
```



```{r funcao_ler_receitas}

ler_receitas <- function(x) {read_delim(x, 
    delim = ";", escape_double = FALSE, col_types = cols(`DATA LANÇAMENTO` = col_date(format = "%d/%m/%Y")), 
    locale = locale(date_names = "pt", decimal_mark = ",", 
        grouping_mark = ".", encoding = "Latin1"), 
    trim_ws = TRUE)} 
```

```{r identificar_arquivos_com_dados}

arq_receita <- list.files("C:/Users/andre.ferrari/Documents/R/dados_abertos/receitas/dados_receitas", pattern='*.csv')


```

```{r map_para_ler_arquivos}
setwd("C:/Users/andre.ferrari/Documents/R/dados_abertos/receitas/dados_receitas")
receita <- map_df(arq_receita,ler_receitas)



```


```{r preparar_dados}
receita <- receita %>% clean_names() 

receita <- receita %>% select(categoria_economica , origem_receita ,especie_receita  ,detalhamento, data_lancamento, ano_exercicio, valor_realizado)
                                             
receita <- receita %>% mutate(data_lancamento = as.Date(data_lancamento))                                               
receita <-  receita %>% mutate(tributo = case_when(
   startsWith(detalhamento, "IR"  ) ~ "IR",
   startsWith(detalhamento, "IPI" ) ~ "IPI",
   TRUE ~ "Outro"
  
))                                         
                                               
receita <- receita   %>% mutate(mes = lubridate::month( data_lancamento, label = TRUE, abbr = TRUE), mes_ano = strftime(data_lancamento,format="%b-%Y") )

receita <- receita %>% group_by(categoria_economica , origem_receita ,especie_receita  ,detalhamento, tributo,ano_exercicio, mes, mes_ano,valor_realizado) %>% summarise(valor_realizado = sum(valor_realizado))


```

```{r}

(receita %>% group_by(categoria_economica, ano_exercicio) %>%  summarise(valor = round(sum(valor_realizado)/1000000000)) %>% arrange((ano_exercicio))  %>% pivot_wider(names_from = ano_exercicio, values_from = valor)) %>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )

```
```{r}

(receita %>% group_by(categoria_economica, origem_receita, ano_exercicio) %>%  summarise(valor = round(sum(valor_realizado)/1000000000)) %>% arrange((ano_exercicio))  %>% pivot_wider(names_from = ano_exercicio, values_from = valor)) %>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )

```


```{r categoria_origem_especie}
(receita %>% group_by(categoria_economica, origem_receita, especie_receita, ano_exercicio) %>%  summarise(valor = round(sum(valor_realizado)/1000000000)) %>% filter(valor>0)  %>% pivot_wider(names_from = ano_exercicio, values_from = valor))  %>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )
```




```{r especie_problema_nome}
receita %>% filter(str_detect(especie_receita,"Contribuições para|Delegação|Exploração do patrimônio im|Indenizações, restituições e |Serviços e Atividades Referentes à N|Transferências de Ou"), mes_ano %in% c("dez-2022","jan-2023")) %>% group_by(especie_receita, mes_ano) %>% summarise(valor= sum(valor_realizado)/1000000) %>% kable(col.names = c("Espécie da Receita", "Mês","R$ bi"), digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )

```




[Como remover caracteres especiais no R](https://rstudio-pubs-static.s3.amazonaws.com/596043_34a6208249e14b2c850cd482b47aab10.html)

Com o glimpse, podemos observar que os nossos dados contém `r Format(length( unique(receita$detalhamento)), fmt=myNumFmt)` registros.

## Receitas

```{r}
receita %>% filter(startsWith(detalhamento,"COFINS-D")| startsWith(detalhamento,"COFINS-JUROS")| startsWith(detalhamento,"CONTRIB.P/FOMENTO RADIODIF")) %>% group_by(detalhamento) %>% summarise(valor =  sum(valor_realizado)/1000)  %>% kable(col.names = c("Detalhamento","Valor R$ mi"), digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )

```

```{r}

receita <- receita %>% mutate (deta_clean = str_to_upper (chartr("áéíóúÁÉÍÓÚýÝàèìòùÀÈÌÒÙâêîôûÂÊÎÔÛãõÃÕñÑäëïöüÄËÏÖÜÿçÇ",
                 "aeiouaeiouyyaeiouaeiouaeiouaeiouaoaonnaeiouaeiouycc",detalhamento) ))

```

```{r}
receita %>% filter(startsWith(detalhamento,"COFINS-D")| startsWith(detalhamento,"COFINS-JUROS")| startsWith(detalhamento,"CONTRIB.P/FOMENTO RADIODIF")) %>% group_by(deta_clean, detalhamento) %>% summarise(valor =  sum(valor_realizado)/1000000)  %>% kable(col.names = c("Deta_clean","Detalhamento","Valor R$ mi"), digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )
```

Com o glimpse, podemos observar que os nossos dados contém `r Format(length( unique(receita$deta_clean)), fmt=myNumFmt)` registros.



```{r}
receita <- receita %>% mutate(tipo = case_when(
    str_detect(deta_clean, "INTRA") ~ "02 - Intra",
    str_detect(deta_clean, "JUROS") |str_detect(deta_clean, "JUR")|str_detect(deta_clean, "-MUL")| str_detect(deta_clean, "DIV.AT") | str_detect(deta_clean, "ATIVA") & ! str_detect(deta_clean, "INTRA") ~ "03 - Dívida Ativa, Multas e Juros",
    TRUE ~ "01 - Principal"))
```




```{r}
(receita %>% group_by(tipo, ano_exercicio) %>%  summarise(valor = round(sum(valor_realizado)/1000000000)) %>% arrange((ano_exercicio))  %>% pivot_wider(names_from = ano_exercicio, values_from = valor)) %>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") )
```





```{r}
datatable(receita %>% filter(especie_receita =="Operações de crédito - mercado interno", str_detect(deta_clean,"TIT"), tipo == "01 - Principal") %>% group_by(especie_receita ,tipo,deta_clean, ano_exercicio) %>%  summarise(valor = round(sum(valor_realizado)/1000000000)) %>% arrange((ano_exercicio))  %>% pivot_wider(names_from = ano_exercicio, values_from = valor))
```


AMORTIZACAO DE EMPRESTIMOS x Amortizações de Empréstimos

REMUNER.DISPONIBILIDADES TES.NACIONAL-PRINC. x REMUNER.DISPONIBILIDADES DO TESOURO-PRINC.



```{r ipi_ir}
receita %>% filter(tributo %in% c("IR", "IPI"), valor_realizado > 1) %>% group_by(deta_clean, ano_exercicio) %>%  summarise(valor = round(sum(valor_realizado)/1000000000)) %>% arrange (ano_exercicio, desc(valor))  %>% filter(valor > 0)  %>% pivot_wider(names_from = ano_exercicio, values_from = valor)%>% kable( digits = 1, format.args = list(big.mark = ".", decimal.mark = ",") ) 
```


